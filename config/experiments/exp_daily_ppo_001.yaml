# ==============================================================================
# EXP-DAILY-PPO-001: PPO on Daily Bars with Full Macro Coverage
# ==============================================================================
# Contract: CTR-PIPELINE-SSOT-001
# Based on: EXP-HOURLY-PPO-002 lessons (small dataset PPO tuning)
# Variable changed: Bar frequency 1h -> 1d. Full 15 macro features (vs 9).
# ==============================================================================

_meta:
  version: "5.2.0"
  contract_id: "CTR-PIPELINE-SSOT-001"
  experiment_id: "EXP-DAILY-PPO-001"
  based_on: "exp_hourly_ppo_002.yaml"
  based_on_model: "EXP-HOURLY-PPO-002"
  based_on_performance:
    total_return: -7.16
    sharpe_ratio: -1.055
    max_drawdown_pct: 10.52
    profit_factor: 0.90
    trades: 56
    win_rate: 42.9
    seeds_positive: "0/1"
  variable_changed: "Bar frequency 1h->1d. 24 market features (7 technical + 15 macro + 2 temporal). Conservative PPO for 1.2K bars."
  hypothesis: "Daily bars with full macro coverage (15 vars inc. coffee, WTI, COLCAP, CLP) provide richer fundamental signal for RL"
  created_at: "2026-02-14"
  status: "failed"
  results:
    mean_return: -8.83
    sharpe: -2.797
    seeds_positive: "0/1"
    decision: "FAIL â€” only 8 trades, 12.5% WR, insufficient data for RL"
  description: |
    Daily PPO experiment with full macro feature set.
    1 bar/day = 252 bars/year = ~1,200 training bars.
    Key advantage: all 15 daily macro variables align perfectly.
    Conservative PPO: 200K steps, ent_coef=0.05, [128,128] network.
    New features: coffee, WTI, COLCAP, CLP, COL5Y, IBR.

# ==============================================================================
# SECTION 1: PIPELINE PATHS & DATA SOURCES
# ==============================================================================

paths:
  project_root: "/opt/airflow"
  local_root: "C:/Users/pedro/OneDrive/Documents/ALGO TRADING/USDCOP/USDCOP-RL-Models"

  sources:
    ohlcv_table: "usdcop_m5_ohlcv"
    ohlcv_seed: "seeds/latest/usdcop_daily_ohlcv.parquet"  # DAILY seed
    macro_daily_table: "macro_indicators_daily"
    macro_monthly_table: "macro_indicators_monthly"

    macro_column_map:
      # === 9 existing (from V21.5b) ===
      FXRT_INDEX_DXY_USA_D_DXY: dxy
      VOLT_VIX_USA_D_VIX: vix
      CRSK_SPREAD_EMBI_COL_D_EMBI: embi
      COMM_OIL_BRENT_GLB_D_BRENT: brent
      COMM_METAL_GOLD_GLB_D_GOLD: gold
      FINC_BOND_YIELD10Y_COL_D_COL10Y: col10y
      FINC_BOND_YIELD10Y_USA_D_UST10Y: ust10y
      FINC_BOND_YIELD2Y_USA_D_DGS2: ust2y
      FXRT_SPOT_USDMXN_MEX_D_USDMXN: usdmxn
      # === 6 NEW daily macro features ===
      COMM_AGRI_COFFEE_GLB_D_COFFEE: coffee       # Colombia's #1 export
      COMM_OIL_WTI_GLB_D_WTI: wti                 # WTI oil price
      EQTY_INDEX_COLCAP_COL_D_COLCAP: colcap      # Colombian stock index
      FXRT_SPOT_USDCLP_CHL_D_USDCLP: usdclp      # Chile peso (regional peer)
      FINC_BOND_YIELD5Y_COL_D_COL5Y: col5y        # Colombia 5Y yield
      FINC_RATE_IBR_OVERNIGHT_COL_D_IBR: ibr       # Overnight interbank rate

  l2_output:
    base_dir: "data/pipeline/07_output/daily"
    dataset_prefix: "DS_production"
    train_file: "data/pipeline/07_output/daily/DS_production_train.parquet"
    val_file: "data/pipeline/07_output/daily/DS_production_val.parquet"
    test_file: "data/pipeline/07_output/daily/DS_production_test.parquet"
    norm_stats_file: "data/pipeline/07_output/daily/DS_production_norm_stats.json"
    lineage_file: "data/pipeline/07_output/daily/DS_production_lineage.json"

  l3_output:
    models_dir: "models"
    model_prefix: "ppo_hourly"
    model_file: "final_model.zip"
    policy_weights: "policy_weights.pt"
    norm_stats: "norm_stats.json"
    training_config: "training_config.json"
    training_result: "training_result.json"

  l4_output:
    results_dir: "results/backtests"
    reports_dir: "results/validation_reports"

# ==============================================================================
# SECTION 1B: AUXILIARY PAIRS (Disabled for this experiment)
# ==============================================================================

aux_pairs:
  enabled: false  # V21.5b baseline: no cross-pair features
  pairs:
    usdmxn:
      symbol: "USD/MXN"
      seed_file: "seeds/latest/usdmxn_m5_ohlcv.parquet"
    usdbrl:
      symbol: "USD/BRL"
      seed_file: "seeds/latest/usdbrl_m5_ohlcv.parquet"
  session:
    timezone: "America/Bogota"
    start: "08:00"
    end: "12:55"

# ==============================================================================
# SECTION 2: DATE RANGES & SPLITS
# ==============================================================================

date_ranges:
  data_start: "2020-01-01"
  data_end: "2026-02-04"

  train_start: "2020-01-01"
  train_end: "2024-12-31"

  val_start: "2025-01-01"
  val_end: "2025-06-30"

  test_start: "2025-07-01"
  test_end: "2025-12-31"

  use_fixed_dates: true
  train_ratio: 0.70
  val_ratio: 0.15
  test_ratio: 0.15

# ==============================================================================
# SECTION 2B: TRADING SCHEDULE (DAILY)
# ==============================================================================
# USDCOP: 1 bar per trading day, ~252 trading days per year

trading_schedule:
  market_open_utc: 13
  market_close_utc: 18
  trading_hours_per_day: 5.0
  bar_interval_minutes: 1440        # 1 day = 1440 minutes
  bars_per_hour: 0.2                # 1/5 (1 bar per 5 hours)
  bars_per_day: 1                   # 1 bar/day
  trading_days_per_year: 252
  bars_per_year: 252                # 252 * 1
  backtest_warmup_bars: 50          # 50 trading days (for SMA(50))
  backtest_margin_bars: 5           # Reserved at end

# ==============================================================================
# SECTION 3: FEATURE CALCULATORS REGISTRY
# ==============================================================================

calculators:
  log_return:
    module: "src.features.technical_indicators"
    function: "calculate_log_returns"
    description: "Log return: ln(price_t / price_{t-n})"

  rsi_wilders:
    module: "src.features.technical_indicators"
    function: "calculate_rsi_wilders"
    description: "RSI with Wilder's exponential smoothing"

  volatility_pct:
    module: "src.features.technical_indicators"
    function: "calculate_volatility_pct"
    description: "Realized volatility as annualized percentage"

  trend_z:
    module: "src.features.technical_indicators"
    function: "calculate_trend_z"
    description: "Price position relative to SMA as z-score"

  macro_zscore:
    module: "src.features.technical_indicators"
    function: "calculate_macro_zscore"
    description: "Rolling z-score for macro variables"

  pct_change:
    module: "pandas"
    function: "Series.pct_change"
    description: "Simple percentage change"

  spread_zscore:
    module: "src.features.technical_indicators"
    function: "calculate_spread_zscore"
    description: "Spread between two series as z-score"

# ==============================================================================
# SECTION 4: FEATURE DEFINITIONS (24 market + 7 state = 31 obs_dim)
# ==============================================================================
# Daily bar features:
# - 4 log returns: 1d, 5d (1w), 22d (1m), 66d (1q)
# - 3 technical: rsi_14, volatility_20d, trend_z(50)
# - 15 macro: 9 existing + 6 new (coffee, wti, colcap, clp, col5y, ibr)
# - 2 temporal: dow_sin, dow_cos (no hour encoding for daily)
# ==============================================================================

features:
  observation_dim: 31  # 24 market + 7 state

  market_features:
    # =========================================================================
    # RETURNS (4 features) - Multi-timeframe momentum at daily scale
    # =========================================================================
    - name: log_ret_1d
      order: 0
      category: returns
      description: "1-day log return (1 bar)"
      source: ohlcv
      input_columns: [close]
      calculator: log_return
      params:
        periods: 1
      preprocessing:
        dropna: true
        clip_outliers: [-0.10, 0.10]
      normalization:
        method: zscore
        clip: [-5, 5]
        compute_on: train_only
      validation:
        expected_mean: [-0.002, 0.002]
        expected_std: [0.001, 0.015]
      importance: CRITICAL

    - name: log_ret_5d
      order: 1
      category: returns
      description: "5-day log return (1 week)"
      source: ohlcv
      input_columns: [close]
      calculator: log_return
      params:
        periods: 5
      preprocessing:
        dropna: true
        clip_outliers: [-0.15, 0.15]
      normalization:
        method: zscore
        clip: [-5, 5]
        compute_on: train_only
      importance: HIGH

    - name: log_ret_22d
      order: 2
      category: returns
      description: "22-day log return (1 month)"
      source: ohlcv
      input_columns: [close]
      calculator: log_return
      params:
        periods: 22
      preprocessing:
        dropna: true
        clip_outliers: [-0.25, 0.25]
      normalization:
        method: zscore
        clip: [-5, 5]
        compute_on: train_only
      importance: HIGH

    - name: log_ret_66d
      order: 3
      category: returns
      description: "66-day log return (1 quarter)"
      source: ohlcv
      input_columns: [close]
      calculator: log_return
      params:
        periods: 66
      preprocessing:
        dropna: true
        clip_outliers: [-0.30, 0.30]
      normalization:
        method: zscore
        clip: [-5, 5]
        compute_on: train_only
      importance: MEDIUM

    # =========================================================================
    # TECHNICAL INDICATORS (3 features) - Daily scale
    # =========================================================================
    - name: rsi_14
      order: 4
      category: technical
      description: "RSI period 14 (standard daily RSI)"
      source: ohlcv
      input_columns: [close]
      calculator: rsi_wilders
      params:
        period: 14
      preprocessing:
        dropna: true
      normalization:
        method: minmax
        input_range: [0, 100]
        output_range: [0, 1]
      validation:
        expected_range: [0, 100]
      importance: HIGH

    - name: volatility_pct
      order: 5
      category: technical
      description: "Realized volatility % (annualized, 20-day window)"
      source: ohlcv
      input_columns: [close]
      calculator: volatility_pct
      params:
        period: 20
        annualize: true
        bars_per_day: 1           # 1 daily bar per day
      preprocessing:
        dropna: true
        floor: 0.0
      normalization:
        method: zscore
        clip: [-3, 5]
        compute_on: train_only
      importance: HIGH

    - name: trend_z
      order: 6
      category: technical
      description: "Price vs SMA(50) z-score (50 trading days)"
      source: ohlcv
      input_columns: [close]
      calculator: trend_z
      params:
        sma_period: 50
        clip_value: 3.0
      preprocessing:
        dropna: true
      normalization:
        method: none
        clip: [-3, 3]
      importance: HIGH

    # =========================================================================
    # MACRO - Currency & Risk (4 features) - existing
    # =========================================================================
    - name: dxy_z
      order: 7
      category: macro_zscore
      description: "Dollar Index rolling z-score (252 days)"
      source: macro_daily
      input_columns: [dxy]
      calculator: macro_zscore
      params:
        window: 252
        method: rolling
      preprocessing:
        ffill_limit: 5
        shift: 1
      normalization:
        method: none
        clip: [-5, 5]
      importance: CRITICAL

    - name: dxy_change_1d
      order: 8
      category: macro_change
      description: "Dollar Index 1-day % change"
      source: macro_daily
      input_columns: [dxy]
      calculator: pct_change
      params:
        periods: 1
      preprocessing:
        ffill_limit: 5
        shift: 1
        clip_outliers: [-0.05, 0.05]
      normalization:
        method: zscore
        clip: [-5, 5]
        compute_on: train_only
      importance: HIGH

    - name: vix_z
      order: 9
      category: macro_zscore
      description: "VIX volatility index z-score"
      source: macro_daily
      input_columns: [vix]
      calculator: macro_zscore
      params:
        window: 252
        method: rolling
      preprocessing:
        ffill_limit: 5
        shift: 1
      normalization:
        method: none
        clip: [-5, 5]
      importance: HIGH

    - name: embi_z
      order: 10
      category: macro_zscore
      description: "EMBI Colombia z-score (country risk)"
      source: macro_daily
      input_columns: [embi]
      calculator: macro_zscore
      params:
        window: 252
        method: rolling
      preprocessing:
        ffill_limit: 5
        shift: 1
      normalization:
        method: none
        clip: [-5, 5]
      importance: HIGH

    # =========================================================================
    # MACRO - Commodities (4 features) - 2 existing + 2 NEW
    # =========================================================================
    - name: brent_change_1d
      order: 11
      category: macro_change
      description: "Brent crude oil 1-day % change"
      source: macro_daily
      input_columns: [brent]
      calculator: pct_change
      params:
        periods: 1
      preprocessing:
        ffill_limit: 5
        shift: 1
        clip_outliers: [-0.15, 0.15]
      normalization:
        method: zscore
        clip: [-5, 5]
        compute_on: train_only
      importance: HIGH

    - name: gold_change_1d
      order: 12
      category: macro_change
      description: "Gold 1-day % change"
      source: macro_daily
      input_columns: [gold]
      calculator: pct_change
      params:
        periods: 1
      preprocessing:
        ffill_limit: 5
        shift: 1
        clip_outliers: [-0.10, 0.10]
      normalization:
        method: zscore
        clip: [-5, 5]
        compute_on: train_only
      importance: MEDIUM

    - name: coffee_change_1d
      order: 13
      category: macro_change
      description: "Coffee 1-day % change (Colombia #1 export)"
      source: macro_daily
      input_columns: [coffee]
      calculator: pct_change
      params:
        periods: 1
      preprocessing:
        ffill_limit: 5
        shift: 1
        clip_outliers: [-0.15, 0.15]
      normalization:
        method: zscore
        clip: [-5, 5]
        compute_on: train_only
      importance: HIGH

    - name: wti_change_1d
      order: 14
      category: macro_change
      description: "WTI crude oil 1-day % change"
      source: macro_daily
      input_columns: [wti]
      calculator: pct_change
      params:
        periods: 1
      preprocessing:
        ffill_limit: 5
        shift: 1
        clip_outliers: [-0.15, 0.15]
      normalization:
        method: zscore
        clip: [-5, 5]
        compute_on: train_only
      importance: HIGH

    # =========================================================================
    # MACRO - Interest Rates & Spreads (3 features) - existing
    # =========================================================================
    - name: rate_spread_z
      order: 15
      category: macro_zscore
      description: "Rate spread (COL10Y - UST10Y) z-score"
      source: macro_daily
      input_columns: [col10y, ust10y]
      calculator: spread_zscore
      params:
        window: 252
        spread_formula: "col10y - ust10y"
      preprocessing:
        ffill_limit: 5
        shift: 1
      normalization:
        method: none
        clip: [-4, 4]
      importance: HIGH

    - name: yield_curve_z
      order: 16
      category: macro_zscore
      description: "US yield curve (10Y-2Y) z-score"
      source: macro_daily
      input_columns: [ust10y, ust2y]
      calculator: spread_zscore
      params:
        window: 252
        spread_formula: "ust10y - ust2y"
      preprocessing:
        ffill_limit: 5
        shift: 1
      normalization:
        method: none
        clip: [-4, 4]
      importance: MEDIUM

    - name: carry_spread_z
      order: 17
      category: macro_zscore
      description: "Carry spread (COL10Y - UST10Y) z-score"
      source: macro_daily
      input_columns: [col10y, ust10y]
      calculator: spread_zscore
      params:
        window: 63
        spread_formula: "col10y - ust10y"
      preprocessing:
        ffill_limit: 5
        shift: 1
      normalization:
        method: none
        clip: [-5, 5]
      importance: HIGH

    # =========================================================================
    # MACRO - FX Peers (2 features) - 1 existing + 1 NEW
    # =========================================================================
    - name: usdmxn_change_1d
      order: 18
      category: macro_change
      description: "USD/MXN 1-day % change (LATAM peer)"
      source: macro_daily
      input_columns: [usdmxn]
      calculator: pct_change
      params:
        periods: 1
      preprocessing:
        ffill_limit: 5
        shift: 1
        clip_outliers: [-0.10, 0.10]
      normalization:
        method: zscore
        clip: [-5, 5]
        compute_on: train_only
      importance: HIGH

    - name: usdclp_change_1d
      order: 19
      category: macro_change
      description: "USD/CLP 1-day % change (Chile peer)"
      source: macro_daily
      input_columns: [usdclp]
      calculator: pct_change
      params:
        periods: 1
      preprocessing:
        ffill_limit: 5
        shift: 1
        clip_outliers: [-0.10, 0.10]
      normalization:
        method: zscore
        clip: [-5, 5]
        compute_on: train_only
      importance: HIGH

    # =========================================================================
    # MACRO - Colombia Domestic (2 NEW features)
    # =========================================================================
    - name: colcap_change_1d
      order: 20
      category: macro_change
      description: "COLCAP stock index 1-day % change"
      source: macro_daily
      input_columns: [colcap]
      calculator: pct_change
      params:
        periods: 1
      preprocessing:
        ffill_limit: 5
        shift: 1
        clip_outliers: [-0.10, 0.10]
      normalization:
        method: zscore
        clip: [-5, 5]
        compute_on: train_only
      importance: HIGH

    - name: ibr_z
      order: 21
      category: macro_zscore
      description: "IBR overnight rate z-score (liquidity indicator)"
      source: macro_daily
      input_columns: [ibr]
      calculator: macro_zscore
      params:
        window: 252
        method: rolling
      preprocessing:
        ffill_limit: 5
        shift: 1
      normalization:
        method: none
        clip: [-5, 5]
      importance: HIGH

  # ===========================================================================
  # STATE FEATURES (7) - Computed at runtime by TradingEnv
  # ===========================================================================
  # No hour encoding for daily bars. Only dow_sin/dow_cos for temporal.
  state_features:
    - name: position
      order: 22
      category: state
      description: "Current position (-1=SHORT, 0=FLAT, 1=LONG)"
      source: runtime
      normalization:
        method: none
        clip: [-1, 1]
      importance: CRITICAL

    - name: unrealized_pnl
      order: 23
      category: state
      description: "Unrealized P&L as fraction of entry price"
      source: runtime
      normalization:
        method: clip
        clip: [-1.0, 1.0]
      importance: CRITICAL

    - name: sl_proximity
      order: 24
      category: state
      description: "Distance to stop-loss"
      source: runtime
      normalization:
        method: clip
        clip: [0.0, 1.0]
      importance: HIGH

    - name: tp_proximity
      order: 25
      category: state
      description: "Proximity to take-profit"
      source: runtime
      normalization:
        method: clip
        clip: [0.0, 1.0]
      importance: HIGH

    - name: bars_held
      order: 26
      category: state
      description: "Bars in position normalized to [0,1]"
      source: runtime
      normalization:
        method: clip
        clip: [0.0, 1.0]
      importance: HIGH

    - name: dow_sin
      order: 27
      category: temporal
      description: "Sine encoding of day-of-week"
      source: runtime
      normalization:
        method: none
        clip: [-1.0, 1.0]
      importance: MEDIUM

    - name: dow_cos
      order: 28
      category: temporal
      description: "Cosine encoding of day-of-week"
      source: runtime
      normalization:
        method: none
        clip: [-1.0, 1.0]
      importance: MEDIUM

  # ===========================================================================
  # RAW FEATURES (not in observation, for PnL calculation)
  # ===========================================================================
  auxiliary_features:
    - name: raw_log_ret_1d
      description: "Raw (unnormalized) 1-day log return for PnL calculation"
      source: ohlcv
      input_columns: [close]
      calculator: log_return
      params:
        periods: 1
      normalization:
        method: none
      note: "Used by TradingEnv for actual PnL computation"

# ==============================================================================
# SECTION 5: PREPROCESSING CONFIGURATION
# ==============================================================================

preprocessing:
  ohlcv:
    drop_duplicates: true
    sort_by: time
    handle_gaps:
      max_gap_minutes: 4320    # 3 days max gap for daily bars (weekends + holidays)
      action: ffill
    handle_outliers:
      method: clip
      price_change_threshold: 0.05
    trading_hours:
      enabled: true
      start_utc: 13
      end_utc: 18
      exclude_weekends: true

  macro:
    ffill_limits:
      daily: 5
      monthly: 35
      quarterly: 95
    anti_leakage:
      shift_days: 1
      reason: "Prevent look-ahead bias"

  min_rows_required: 500        # ~2 years of daily bars
  max_null_percentage: 0.01

  normalization:
    compute_on: train_only
    save_stats: true
    stats_file: "{output_dir}/{prefix}_norm_stats.json"

# ==============================================================================
# SECTION 6: TRAINING CONFIGURATION (L3) - V21.5b PPO parameters
# ==============================================================================

training:
  algorithm: "ppo"              # V21.5b: PPO (not SAC)
  device: "cpu"                 # V21.5b: CPU for PPO MlpPolicy

  # PPO Hyperparameters (Conservative for ~1.2K training bars)
  ppo:
    learning_rate: 0.0003
    n_steps: 1024               # Small buffer for small dataset
    batch_size: 64              # Smaller batches for small data
    n_epochs: 5                 # Fewer epochs to prevent overfitting
    gamma: 0.99                 # Higher gamma for daily (longer horizons)
    gae_lambda: 0.95
    clip_range: 0.2
    clip_range_vf: null
    ent_coef: 0.05              # High entropy to prevent collapse on tiny dataset
    vf_coef: 0.5
    max_grad_norm: 0.5
    normalize_advantage: true

  # Network architecture (Small for ~1.2K bars)
  network:
    policy_layers: [128, 128]   # Smaller network (was [256,256])
    value_layers: [128, 128]
    activation: tanh

  # Training schedule
  schedule:
    total_timesteps: 200000     # 200K (~167x per bar)
    eval_freq: 10000            # Eval every 10K (20 evals total)
    n_eval_episodes: 10
    checkpoint_freq: 50000

    lr_decay:
      enabled: false

    early_stopping:
      enabled: true
      patience: 10
      min_delta: 0.5

  # Curriculum: disabled for simplicity
  curriculum:
    enabled: false

  # Environment configuration (adapted for daily)
  environment:
    episode_length: 60            # 60 trading days (~3 months)
    warmup_bars: 50               # 50 trading days (for SMA(50))
    initial_balance: 10000.0
    decision_interval: 1          # Every daily bar

    # Transaction costs (V21.5b: MEXC maker)
    transaction_cost_bps: 0.0
    slippage_bps: 1.0

    # Position management (adapted for daily)
    max_position: 1.0
    max_drawdown_pct: 15.0
    max_position_duration: 60     # 60 trading days

    # Risk management (V21.5b proven stops)
    stop_loss_pct: -0.04
    stop_loss_penalty: 0.3
    take_profit_pct: 0.04
    take_profit_bonus: 0.5
    exit_bonus: 0.2

    # Trailing stop DISABLED (V21.5b)
    trailing_stop:
      enabled: false
      activation_pct: 0.015
      trail_factor: 0.5
      min_trail_pct: 0.007
      bonus: 0.25

    # Action thresholds (V21.5b proven)
    thresholds:
      long: 0.35
      short: -0.35

  # Reward delivery (daily scale)
  reward_interval: 5              # Every 5 trading days (weekly)

  # Min hold (daily scale)
  min_hold_bars: 3                # 3 trading days minimum

  # Reward configuration (V21.5b weights)
  reward:
    weights:
      pnl: 0.90
      dsr: 0.00
      sortino: 0.00
      regime_penalty: 0.05
      holding_decay: 0.05
      anti_gaming: 0.00

    pnl_transform:
      clip_range: [-0.1, 0.1]
      zscore_window: 100
      zscore_clip: 3.0
      asymmetric:
        win_multiplier: 1.0
        loss_multiplier: 1.0

    holding_decay:
      half_life_bars: 20          # 20 trading days
      max_penalty: 0.15
      flat_threshold: 3           # 3 trading days

    flat_reward:
      enabled: false
      weight: 0.0
      decay_enabled: true
      decay_half_life: 12

  # Multi-seed training
  multi_seed:
    enabled: true
    seeds: [42, 123, 456, 789, 1337]
    selection_metric: "best_mean_reward"
    max_cv_threshold: 0.30
    save_all_models: true

  # V21.5b: Continuous action space
  action_type: "continuous"
  n_actions: 1

  # V21.5b: LSTM disabled
  lstm:
    enabled: false
    hidden_size: 128
    n_layers: 1
    sequence_length: 64

  # Temporal features (daily: only day-of-week, no hour)
  temporal_features:
    enabled: true
    features: [dow_sin, dow_cos]

  # Ensemble config (kept for compatibility)
  ensemble:
    n_models: 5
    min_consensus: 3
    voting: "majority"
    confidence_weighted: true

  # Position sizing (kept for compatibility)
  position_sizing:
    method: "half_kelly"
    base_fraction: 0.063
    min_fraction: 0.02
    max_fraction: 0.15
    consensus_scaling: true

  # Close shaping DISABLED (V21.5b)
  close_shaping:
    enabled: false
    stop_loss_mult: 1.5
    take_profit_mult: 1.2
    agent_close_win: 1.1
    agent_close_loss: 0.7
    timeout_mult: 0.8

  # Walk-forward disabled
  walk_forward:
    enabled: false
    train_window: "expanding"
    retrain_frequency: "quarterly"
    min_train_bars: 500
    val_window_bars: 100
    test_window_bars: 100
    n_splits: 4

# ==============================================================================
# SECTION 7: BACKTEST CONFIGURATION (L4)
# ==============================================================================

backtest:
  decision_interval: 1

  costs:
    transaction_cost_bps: 0.0
    slippage_bps: 1.0

  thresholds:
    long: 0.35
    short: -0.35

  risk_management:
    stop_loss_pct: -0.04
    take_profit_pct: 0.04
    trailing_stop:
      enabled: false
      activation_pct: 0.015
      trail_factor: 0.5
    max_position_duration: 60

  initial_capital: 10000.0

  test_dataset: "${paths.l2_output.test_file}"
  norm_stats: "${paths.l2_output.norm_stats_file}"

  gates:
    min_return_pct: 0.0
    min_sharpe_ratio: 0.0
    max_drawdown_pct: 20.0
    min_trades: 10              # Very few trades expected at daily (~0.5/week)
    min_win_rate: 0.35
    max_action_imbalance: 0.85

# ==============================================================================
# SECTION 8: VALIDATION & QUALITY GATES
# ==============================================================================

validation:
  dataset:
    min_rows:
      train: 500                # ~2 years daily
      val: 50                   # ~2.5 months daily
      test: 50                  # ~2.5 months daily
    max_null_pct: 0.01
    feature_checks:
      - pattern: "*_z"
        check: "abs(mean) < 0.5 and 0.5 < std < 1.5"
        description: "Z-scores should be ~N(0,1)"
      - pattern: "rsi_*"
        check: "0 <= min and max <= 100"
        description: "RSI bounded [0, 100]"
      - pattern: "log_ret_*"
        check: "abs(mean) < 0.01"
        description: "Returns should have mean ~0"

  training:
    min_reward_improvement: 0.05
    max_policy_loss: 0.5
    min_explained_variance: 0.3

  backtest:
    promotion_thresholds:
      min_apr_pct: 5.0
      max_drawdown_pct: 20.0
      min_sharpe: 0.5
      min_profit_factor: 0.8
      min_trades: 10

  comparison:
    baseline_model: null
    max_degradation_pct: 15.0

# ==============================================================================
# SECTION 9: LOGGING & MONITORING
# ==============================================================================

logging:
  mlflow:
    enabled: true
    tracking_uri: "mlruns"
    experiment_name: "usdcop_rl_hourly"

  tensorboard:
    enabled: true
    log_dir: "logs/tensorboard"

  metrics:
    training:
      - "episode_reward"
      - "policy_loss"
      - "value_loss"
      - "entropy"
      - "learning_rate"
    backtest:
      - "total_return"
      - "sharpe_ratio"
      - "max_drawdown"
      - "win_rate"
      - "profit_factor"

# ==============================================================================
# SECTION 10: DERIVED VALUES
# ==============================================================================

derived:
  feature_order:
    # Market features (18)
    - log_ret_1h          # 0
    - log_ret_4h          # 1
    - log_ret_1d          # 2
    - log_ret_1w          # 3
    - rsi_9               # 4
    - rsi_21              # 5
    - volatility_pct      # 6
    - trend_z             # 7
    - dxy_z               # 8
    - dxy_change_1d       # 9
    - vix_z               # 10
    - embi_z              # 11
    - brent_change_1d     # 12
    - gold_change_1d      # 13
    - rate_spread_z       # 14
    - yield_curve_z       # 15
    - usdmxn_change_1d    # 16
    - carry_spread_z      # 17
    # State features (9)
    - position            # 18
    - unrealized_pnl      # 19
    - sl_proximity        # 20
    - tp_proximity        # 21
    - bars_held           # 22
    - hour_sin            # 23
    - hour_cos            # 24
    - dow_sin             # 25
    - dow_cos             # 26

  required_columns:
    ohlcv: [close]
    macro_daily: [dxy, vix, embi, brent, gold, col10y, ust10y, ust2y, usdmxn]

  observation_dim: 27
  market_features_count: 18
  state_features_count: 9

  action_type: "continuous"
  n_actions: 1
  action_mapping:
    threshold_long: 0.35
    threshold_short: -0.35

# ==============================================================================
# END OF CONFIGURATION
# ==============================================================================
