# USD/COP Trading System - Data Flow Architecture

## Overview

This document describes the complete data flow from raw market data acquisition through to RL model inference and visualization.

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          DATA FLOW ARCHITECTURE                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌───────────┐  │
│  │   External  │ --> │   L0: Raw   │ --> │  L1-L4:     │ --> │  L5: RL   │  │
│  │   Sources   │     │   Acquire   │     │  Transform  │     │ Inference │  │
│  └─────────────┘     └─────────────┘     └─────────────┘     └───────────┘  │
│        │                   │                   │                   │         │
│        v                   v                   v                   v         │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌───────────┐  │
│  │  TwelveData │     │ TimescaleDB │     │   MinIO     │     │ Dashboard │  │
│  │   + FRED    │     │  (Tables)   │     │  (Buckets)  │     │   (UI)    │  │
│  └─────────────┘     └─────────────┘     └─────────────┘     └───────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 1. Data Sources

### 1.1 Real-time Market Data (5-minute frequency)
- **Source**: TwelveData API
- **Symbol**: USD/COP
- **Interval**: 5 minutes
- **DAG**: `v3.l0_ohlcv_realtime` (every 5 min during market hours)
- **Table**: `usdcop_m5_ohlcv`

### 1.2 Macroeconomic Data (daily frequency)
- **Sources**:
  - FRED (Federal Reserve Economic Data)
  - Banco de la República Colombia
  - Yahoo Finance (commodities)
- **Columns**: 37 macroeconomic indicators
- **Table**: `macro_indicators_daily`

## 2. Database Schema

### 2.1 Primary Tables

```sql
-- 5-minute OHLCV data (TimescaleDB hypertable)
usdcop_m5_ohlcv (
    time TIMESTAMPTZ PRIMARY KEY,
    symbol TEXT,
    open, high, low, close DECIMAL,
    volume BIGINT,
    source TEXT
)

-- Daily macroeconomic indicators (37 columns)
macro_indicators_daily (
    fecha DATE PRIMARY KEY,
    -- Commodities (4)
    comm_agri_coffee_glb_d_coffee,
    comm_metal_gold_glb_d_gold,
    comm_oil_brent_glb_d_brent,
    comm_oil_wti_glb_d_wti,
    -- FX & Risk (7 key features for inference)
    fxrt_index_dxy_usa_d_dxy,      -- DXY
    volt_vix_usa_d_vix,            -- VIX
    crsk_spread_embi_col_d_embi,   -- EMBI
    fxrt_spot_usdmxn_mex_d_usdmxn, -- USD/MXN
    ...
)
```

### 2.2 Feature Tables (Generated by Airflow DAGs)

```sql
-- L1: Standardized features
inference_features_5m (
    time TIMESTAMPTZ PRIMARY KEY,
    -- 13 normalized features
    ret_1h, ret_4h, ret_1d,
    volatility_20, rsi_14, atr_pct,
    dxy_z, vix_z, embi_z,
    usdmxn_ret_1h, hour_sin, hour_cos,
    dow_sin
)

-- L5: RL inference results
dw.fact_rl_inference (
    id SERIAL,
    timestamp TIMESTAMPTZ,
    bar_number INT,
    action DOUBLE PRECISION  -- [-1, 1] position signal
)

-- Agent actions (for visualization)
dw.fact_agent_actions (
    id SERIAL,
    timestamp TIMESTAMPTZ,
    action_type TEXT,
    position FLOAT,
    price DECIMAL
)
```

## 3. Pipeline Layers (Airflow DAGs)

### Layer 0: Raw Data Acquisition
```
DAG: v3.l0_ohlcv_realtime
Schedule: */5 13-17 * * 1-5 (Every 5 min, Mon-Fri, 8-12 COT)
Source: TwelveData API
Target: usdcop_m5_ohlcv table

DAG: v3.l0_ohlcv_backfill  [NEW]
Schedule: Manual trigger / On startup
Purpose: Automatically fills gaps in OHLCV data after backup restore
Features:
- Detects last recorded timestamp
- Calculates missing market hours (8am-12:55pm COT, Mon-Fri)
- Excludes Colombian holidays
- Fetches data in batches from TwelveData API
- Rate-limited to avoid API throttling

DAG: v3.l0_macro_daily
Schedule: 0 18 * * 1-5 (Daily at 1:00 PM COT)
Source: FRED, BanRep, Yahoo Finance
Target: macro_indicators_daily table
```

### Layer 1: Feature Standardization
```
DAG: v3.l1_feature_standardize
Schedule: */5 13-18 * * 1-5 (5 min after L0)
Source: usdcop_m5_ohlcv, macro_indicators_daily
Target: inference_features_5m table

Key Operations:
- Calculate returns (1h, 4h, 1d)
- Compute technical indicators (RSI, ATR, volatility)
- Z-score normalize macro features (DXY, VIX, EMBI)
- Generate time features (hour_sin, hour_cos, dow_sin)
```

### Layer 3: LLM Features (Optional)
```
DAG: v3.l3_llm_features
Schedule: 0 12 * * 1-5 (Daily before market)
Source: News APIs, sentiment analysis
Target: llm_features_daily table
```

### Layer 4: RL-Ready Features
```
DAG: v3.l4_rlready
Schedule: */5 13-18 * * 1-5
Source: inference_features_5m
Target: rl_ready_5m table

Operations:
- Apply final clipping [-5, 5]
- Validate observation dimensions (15)
- Handle missing values
```

### Layer 5: Model Inference
```
DAG: v3.l5_realtime_inference
Schedule: */5 13-17 * * 1-5 (Market hours only)
Source: inference_features_5m, PPO model
Target: dw.fact_rl_inference table

Observation Space (15 dimensions):
- 13 features from config (feature_config.json)
- 1 position value [-1, 1]
- 1 time_normalized [0, 1]
```

## 4. Docker Services Architecture

```
┌──────────────────────────────────────────────────────────────────────┐
│                     DOCKER COMPOSE SERVICES                          │
├──────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  INFRASTRUCTURE:                                                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                │
│  │  TimescaleDB │  │    Redis     │  │    MinIO     │                │
│  │   (postgres) │  │   (cache)    │  │  (artifacts) │                │
│  │   Port 5432  │  │  Port 6379   │  │ Port 9000/01 │                │
│  └──────────────┘  └──────────────┘  └──────────────┘                │
│                                                                       │
│  DATA PIPELINE:                                                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                │
│  │ data-seeder  │  │  airflow-    │  │  airflow-    │                │
│  │ (init data)  │  │  scheduler   │  │  webserver   │                │
│  │  runs once   │  │  (DAGs)      │  │  Port 8080   │                │
│  └──────────────┘  └──────────────┘  └──────────────┘                │
│                                                                       │
│  REAL-TIME:                                                           │
│  ┌──────────────────────────────────────────────────┐                │
│  │          realtime-ingestion-v2                    │                │
│  │  - Circuit Breaker fault tolerance                │                │
│  │  - Leader Election (Redis locks)                  │                │
│  │  - 5-min polling aligned with candles             │                │
│  │  Port 8087                                        │                │
│  └──────────────────────────────────────────────────┘                │
│                                                                       │
│  API SERVICES:                                                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                │
│  │ trading-api  │  │analytics-api │  │multi-model   │                │
│  │ OHLCV/prices │  │ metrics      │  │ RL inference │                │
│  │  Port 8000   │  │  Port 8001   │  │  Port 8006   │                │
│  └──────────────┘  └──────────────┘  └──────────────┘                │
│                                                                       │
│  UI & MONITORING:                                                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                │
│  │  dashboard   │  │  prometheus  │  │   grafana    │                │
│  │  Next.js UI  │  │  metrics     │  │  dashboards  │                │
│  │  Port 5000   │  │  Port 9090   │  │  Port 3002   │                │
│  └──────────────┘  └──────────────┘  └──────────────┘                │
│                                                                       │
└──────────────────────────────────────────────────────────────────────┘
```

## 5. Data Initialization Flow

### 5.1 First-Time Startup Sequence

```
1. docker-compose up
   │
   ├─> postgres (TimescaleDB)
   │   ├─> init-scripts/01-essential-usdcop-init.sql
   │   │   └─> Creates: users, usdcop_m5_ohlcv, trading_metrics
   │   │
   │   └─> init-scripts/02-macro-indicators-schema.sql
   │       └─> Creates: macro_indicators_daily (37 columns)
   │
   ├─> data-seeder (runs once after postgres healthy)
   │   ├─> Checks if tables are empty
   │   ├─> Loads OHLCV from: archive/backups/database/usdcop_m5_ohlcv_*.csv.gz
   │   ├─> Loads macro from: data/pipeline/05_resampling/output/MACRO_DAILY_CONSOLIDATED.csv
   │   │
   │   └─> Triggers v3.l0_ohlcv_backfill DAG  [NEW]
   │       ├─> Detects gap between backup data and current time
   │       ├─> Calculates missing market hours (8am-12:55pm COT)
   │       ├─> Fetches missing bars from TwelveData API
   │       └─> Updates usdcop_m5_ohlcv to current time
   │
   └─> All other services start after data is seeded
```

### 5.2 Automatic Backfill Flow [NEW]

When the system starts with outdated backup data (e.g., backup from 2024-12-05, current date is 2024-12-17):

```
┌─────────────────────────────────────────────────────────────────────┐
│                    AUTOMATIC BACKFILL FLOW                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  1. Data Seeder loads backup                                        │
│     └─> Last timestamp: 2024-12-05 12:55:00                        │
│                                                                     │
│  2. Triggers v3.l0_ohlcv_backfill DAG                              │
│     │                                                               │
│     ├─> detect_gap task                                             │
│     │   ├─> Query: SELECT MAX(time) FROM usdcop_m5_ohlcv           │
│     │   ├─> Compare with current time                               │
│     │   └─> Calculate expected bars (only market hours)            │
│     │                                                               │
│     ├─> execute_backfill task                                       │
│     │   ├─> Process in monthly chunks                               │
│     │   ├─> For each chunk:                                         │
│     │   │   ├─> Fetch from TwelveData API                          │
│     │   │   ├─> Filter to market hours (8:00-12:55 COT)            │
│     │   │   ├─> Exclude Colombian holidays                          │
│     │   │   ├─> Insert with ON CONFLICT handling                   │
│     │   │   └─> Rate limit delay (2 seconds)                       │
│     │   │                                                           │
│     │   └─> Expected bars for 10 trading days: ~600 bars           │
│     │                                                               │
│     └─> validate_backfill task                                      │
│         └─> Log summary: "Total bars: X, Range: A to B"            │
│                                                                     │
│  3. Result: Database updated to current market time                 │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**Market Hours Configuration** (from feature_config.json):
- Timezone: America/Bogota (COT, UTC-5)
- Trading hours: 8:00 AM - 12:55 PM COT
- Trading days: Monday - Friday (0-4)
- Bars per session: 60 (one every 5 minutes)
- Excludes: Colombian holidays (19 dates in 2025)

### 5.3 Data Files Location

```
project-root/
├── archive/backups/database/
│   └── usdcop_m5_ohlcv_20251205_141629.csv.gz  (811KB, ~1.2M rows)
│
├── data/pipeline/
│   ├── 01_sources/           (41 raw macro data files)
│   │   ├── COMMODITIES/
│   │   ├── COUNTRY_RISK/
│   │   ├── FXRT_RATES/
│   │   └── ...
│   │
│   ├── 05_resampling/output/
│   │   ├── MACRO_DAILY_CONSOLIDATED.csv    (354KB, ~1,200 rows)
│   │   └── MACRO_5MIN_CONSOLIDATED.csv     (26MB, merged with OHLCV)
│   │
│   └── 07_output/datasets_5min/
│       └── RL_DS*.csv                       (10 folds, ~20-40MB each)
│
└── models/
    └── ppo_usdcop_v14_fold0.zip            (Production PPO model)
```

## 6. Feature Configuration (SSOT)

All feature definitions are centralized in `airflow/configs/feature_config.json`:

```json
{
  "observation_space": {
    "total_obs_dim": 15,
    "order": [
      "ret_1h", "ret_4h", "ret_1d",
      "volatility_20", "rsi_14", "atr_pct",
      "dxy_z", "vix_z", "embi_z",
      "usdmxn_ret_1h", "hour_sin", "hour_cos", "dow_sin"
    ]
  },
  "normalization": {
    "ret_1h": {"mean": 0.0, "std": 0.005},
    "dxy_z": {"mean": 0.0, "std": 1.0},
    ...
  },
  "trading": {
    "bars_per_session": 60,
    "market_start_hour": 8,
    "market_end_hour": 12,
    "market_end_minute": 55
  }
}
```

## 7. Model Deployment

### 7.1 Production Model Location
```
models/ppo_usdcop_v14_fold0.zip
```

### 7.2 Inference Pipeline
```
inference_features_5m (13 features)
       │
       v
   ┌───────────────────────┐
   │  build_observation()  │
   │  + position [-1, 1]   │
   │  + time_normalized    │
   └───────────────────────┘
       │
       v
   ┌───────────────────────┐
   │  validate_observation │
   │  - Check dim == 15    │
   │  - Clip to [-5, 5]    │
   │  - Handle NaN/Inf     │
   └───────────────────────┘
       │
       v
   ┌───────────────────────┐
   │  PPO Model Predict    │
   │  action ∈ [-1, 1]     │
   └───────────────────────┘
       │
       v
   dw.fact_rl_inference
```

## 8. Visualization

### 8.1 Dashboard Components
- **OHLCV Chart**: Real-time candlestick with 5-min data
- **Agent Actions**: Position markers on chart
- **Performance Metrics**: Sharpe, Sortino, Max Drawdown
- **Feature Values**: Current observation state

### 8.2 API Endpoints
```
GET /api/ohlcv?symbol=USDCOP&limit=1000
GET /api/agent-actions?limit=100
GET /api/analytics/performance
GET /api/inference/latest
```

---

*Last Updated: 2025-12-17*
*Updated: Added automatic backfill flow documentation*
*Author: Pedro @ Lean Tech Solutions*
